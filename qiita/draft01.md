【C++】最もわかりやすいダブルディスパッチ(仮)の解説

**初カキコ…ども…**  
タイトルは釣りなので気にしないでください。

(仮)がついているのは、これから紹介するテクニックがダブルディスパッチなのか
紹介しているのがダブルディスパッチと異なるものだったらツッコミください

# はじめに
もともと  
**「C++の入出力演算子にポリモーフィックな挙動をさせたい」**  
っていうタイトルにするつもりでした。  
一体誰が読むんだ…と思って~~バズりそうなやつに~~変えた次第です。  

もちろん入出力演算子（`<<`とか`>>`）だけでなく、あらゆる関数のデザインで応用できるテクニックです。

# ポリモーフィズムとは(C++編)
知ってるよって人は本題まで読み飛ばしてください。

例えば、動物(Animal)クラスから犬(Dog)クラスと猫(Cat)クラスが継承している状況があるとします。
動物たちはそれぞれ `void introduce()` という関数を持っていて、これを呼ぶと自己紹介してくれます。

```C++
#include <iostream>

class Animal
{
  public:
    Animal(std::string name)
      : name{name}
    {
    }
  
    void introduce()
    {
      std::cout << "やあ、わたしの名前は " << name << " !" << std::endl;
    }
  
  protected:
    std::string name;
};

int main()
{
  Animal animal{};

  return 0;
}
```


同じ `void introduce()` 関数を呼んでいますが、それぞれ異なった挙動をしてくれます。
当然です。

さて、これにポリモーフィックな挙動をしてもらうために、`void Animal::introduce()` を仮想関数に変更します。

すると、次のようなことが出来ます。

```C++
```

main 内で、Animal のポインタが Dog, Cat のインスタンスを指している状況になっています。
ポインタが指している実態が何なのかを実行時に判別して、勝手に関数の挙動を変えてくれています。
これがポリモーフィズムです。

使いみちの例
ボードゲームを作成するときに
人間vs人間 と 人間vsコンピュータ を実行時に設定できるようにしたいとします。
そういう時に player2 が人間かコンピュータかでいちいち分岐するのではなく、
ポリモーフィックな設計をすることでスマートに書くことが出来ます。

```C++
```

# 本題

今度はメンバ関数ではなく入出力ストリーム用のグローバルな関数を作ります。
とりあえず書いてみたのがこんな感じ。

```C++
```

この関数はグローバルなので、「親の関数」を呼ぶことができないのでスマートではありません。
さらに Dog, Cat も Animal::name を参照しなくちゃいけないので
name を private: 属性にすることも出来ません
~~クソクソのクソです。~~

さらにポリモーフィックな挙動をさせようとすると、、

```C++
```

おや、基底クラス(Animal)の方が呼ばれてますね・・・
とまあかなり困ったことになります。


# 解決策
早い話、**ダブルディスパッチ** を使えば解決します。  
どういうことかといいますと、  

```C++
```

# 要するに
実体が何者なのかは、

**引数にとる型で判断することはできない。**  
**実際にそれを触って・動かして初めて実態が何なのかが分かる。**  

ダブルディスパッチとは、この考えのもとにあるのではないでしょうか。  
え、知ってた？


# おわりに
趣味で[RPGゲーム](https://github.com/tanacchi/rogue_game)を作ってて今回のテクニックが必要になりました。  
このテクニックにダブルディスパッチっていう名前がついてることを知ったのは  
実装からしばらく経ってからでした。  
世紀の大発見ならず。トホホ

